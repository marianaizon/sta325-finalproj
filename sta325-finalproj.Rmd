---
title: "Sta 325 Final Project"
author: "Calleigh Smith, Hannah Bogomilsky, Hugh Esterson, Maria Henriquez, Mariana Izon"
date: "11/22/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-packages, message=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(gridExtra)
library(mgcv)
library(patchwork)
```


```{r load-clean-data, warning=FALSE, message=FALSE}
# read data
flights <- read_csv("data/flights.csv")

# find unique airlines, destinations, and types of delays
unique(flights$OP_CARRIER)
unique(flights$DEST)
class(flights$CARRIER_DELAY)

# mutate delays and filter out NA arrival delays
flights <- flights %>% 
  mutate(CARRIER_DELAY = case_when(CARRIER_DELAY > 0 ~ 1,
                                   TRUE ~ 0),
         WEATHER_DELAY = case_when(WEATHER_DELAY > 0 ~ 1,
                                   TRUE ~ 0),
         NAS_DELAY = case_when(NAS_DELAY > 0 ~ 1,
                               TRUE ~ 0),
         SECURITY_DELAY = case_when(SECURITY_DELAY > 0 ~ 1,
                                    TRUE ~ 0),
         LATE_AIRCRAFT_DELAY = case_when(LATE_AIRCRAFT_DELAY > 0 ~ 1,
                                         TRUE ~ 0)) %>% 
  filter(!is.na(ARR_DELAY))

```

```{r}
# glimpse data
flights
```

# INDIVIDUAL PREDICTORS

## Taxi Histograms

```{r, warning=FALSE}
# plot untransformed predictor taxi_in
pTAXI_IN <- ggplot(data = flights, aes(x = TAXI_IN)) +
  geom_histogram(binwidth = 5, fill = "#FFFF00", color = "#002D72", alpha = .7) +
  labs(x = "Time to Taxi In",
       y = "Frequency",
       title = "Histogram of TAXI_IN") + 
  theme(plot.title = element_text(size = 10,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))
  
# plot untransformed predictor taxi_out
pTAXI_OUT <- ggplot(data = flights, aes(x = TAXI_OUT)) +
  geom_histogram(binwidth = 5, fill = "#FFFF00", color = "#002D72", alpha = .7) +
  labs(x = "Time to Taxi Out",
       y = "Frequency",
       title = "Histogram of TAXI_OUT") + 
  theme(plot.title = element_text(size = 10,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))
  
# log transform taxi_in and taxi_out
flights$log_TAXI_OUT <- log(flights$TAXI_OUT)
flights$log_TAXI_IN <- log(flights$TAXI_IN)

# plot log transformed taxi_out
plog_TAXI_OUT <- ggplot(data = flights, aes(x = log_TAXI_OUT)) +
  geom_histogram(fill = "#FFFF00", color = "#002D72", alpha = .7) +
  labs(x = "Time to Taxi Out",
       y = "Frequency",
       title = "Histogram of log(TAXI_OUT)") + 
  theme(plot.title = element_text(size = 10,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))

# plot log transform taxi_in
plog_TAXI_IN <- ggplot(data = flights, aes(x = log_TAXI_IN)) +
  geom_histogram(fill = "#FFFF00", color = "#002D72", alpha = .7) +
  labs(x = "Time to Taxi Out",
       y = "Frequency",
       title = "Histogram of Log(TAXI_IN)") + 
  theme(plot.title = element_text(size = 10,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))

pTAXI_IN + plog_TAXI_IN
pTAXI_OUT + plog_TAXI_OUT
```

## Days of Month and Week

```{r}
# plot predictor DAYS_OF_MONTH
p02 <- ggplot(data = flights, aes(x = DAY_OF_MONTH)) +
  geom_histogram(binwidth = 1, fill = "#E81828", color = "#002D72", alpha = .8) +
  labs(x = "Days of Month",
       y = "Frequency",
       title = "Histogram of Days of Month") +
    theme(plot.title = element_text(size = 10,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))

# plot predictor DAY_OF_WEEK
p03 <- ggplot(data = flights, aes(x = DAY_OF_WEEK)) +
  geom_histogram(binwidth = 1, fill = "#E81828", color = "#002D72", alpha = .8) +
  labs(x = "Day of Week",
       y = "Frequency",
       title = "Histogram of Days of Week") +
    theme(plot.title = element_text(size = 10,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))

grid.arrange(p02, p03, nrow = 1)
```

## Destination Locations

Origin is all JFK, but we could consider the different destination locations. 

```{r}
# plot destinations in CA
ggplot(data = flights, aes(x = DEST)) +
  geom_bar(fill = "#40E0D0", color = "#002D72", alpha = .7) +
  labs(x = "Destinations",
       title = "Bar Plot of Destinations") + 
  theme(plot.title = element_text(size = 12,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))
```

## Airlines

```{r}
# plot airline carriers
ggplot(data = flights, aes(x = OP_CARRIER)) +
  geom_bar(fill = "#40E0D0", color = "#002D72", alpha = .7) +
  labs(x = "Airline",
       title = "Bar Plot of Airlines") + 
  theme(plot.title = element_text(size = 12,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))

# plot airlines by destination
ggplot(data = flights, aes(x = DEST, fill = OP_CARRIER)) +
  geom_bar()
```

## Depart Delay Histogram

```{r, warning = FALSE}
# plot DEP_DELAY
ggplot(data = flights, aes(x = DEP_DELAY)) +
  geom_histogram(binwidth = 4, fill = "#e9c2ed", color = "#002D72", alpha = 0.7) +
  xlim(-25, 50) +
  labs(x = "Departure Delay",
       y = "Frequency",
       title = "Histogram of DEP_DELAY") +
  theme(plot.title = element_text(size = 12,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))

```

```{r}
# plot types of delays
p1 <- ggplot(data = flights, aes(x = CARRIER_DELAY)) +
  geom_bar(fill = "#E81828", color = "#002D72") +
  labs(title = "Carrier Delay")

p2 <- ggplot(data = flights, aes(x = WEATHER_DELAY)) +
  geom_bar(fill = "#E81828", color = "#002D72") +
  labs(title = "Weather Delay")

p3 <- ggplot(data = flights, aes(x = NAS_DELAY)) +
  geom_bar(fill = "#E81828", color = "#002D72") +
  labs(title = "NAS Delay")

p4 <- ggplot(data = flights, aes(x = SECURITY_DELAY)) +
  geom_bar(fill = "#E81828", color = "#002D72") +
  labs(title = "Security Delay")

p5 <- ggplot(data = flights, aes(x = LATE_AIRCRAFT_DELAY)) +
  geom_bar(fill = "#E81828", color = "#002D72") +
  labs(title = "Late Aircraft Delay")

grid.arrange(p1,p2,p3,p4,p5, nrow = 3)
```

From this EDA of the categorical variables, we probably should not perform analysis with `SECURITY_DELAY` since all of them are classified as 0. 

```{r}
flights %>%
  count(WEATHER_DELAY)
```

Furthermore, only 9 flights are classified with a weather delay, so it may not be good for our model to include this as a variable for right now. 

Overall, the categorical delay predictors I would think we could use are: Carrier Delay, NAS Delay, and Late Aircraft Delay

## RESPONSE VARIABLE: ARRIVAL DELAY TIME

I just made it a different color so that when I scroll up to look at distributions I can easily tell the response from predictors (definitely can change at the end).

```{r, warning = FALSE}
# plot ARR_DELAY
ggplot(data = flights, aes(x = ARR_DELAY)) +
  geom_histogram(binwidth = 20, fill = "#002D72", color = "#E81828", alpha = 0.8) +
  xlim(-100, 150) +
  labs(x = "Arrival Delay",
       y = "Frequency",
       title = "Histogram of ARR_DELAY") + 
  theme(plot.title = element_text(size = 12,hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x.bottom = element_text(size = 8, face = "italic"),
        axis.title.y.left = element_text(size = 8))

# 2-parameter BC transformation
## can apply to GAM
```


# PREDICTORS VS RESPONSE

## ARR_DELAY and TAXI_IN / TAXI_OUT

```{r}
p6 <- ggplot(data = flights, aes(y = ARR_DELAY, x = TAXI_IN)) +
  geom_point() +
  labs(title = "Arrival Delay vs Taxi_In")

p7 <- ggplot(data = flights, aes(y = ARR_DELAY, x = TAXI_OUT)) +
  geom_point() +
  labs(title = "Arrival Delay vs Taxi_Out")

grid.arrange(p6,p7, nrow = 1)

plog6 <- ggplot(data = flights, aes(y = ARR_DELAY, x = log_TAXI_IN)) +
  geom_point() +
  labs(title = "Arrival Delay vs log(Taxi_In)")

plog7 <- ggplot(data = flights, aes(y = ARR_DELAY, x = log_TAXI_OUT)) +
  geom_point() +
  labs(title = "Arrival Delay vs log(Taxi_Out)")
grid.arrange(plog6,plog7, nrow = 1)
```

These plots above suggest that we may want to transform the variables at some point. 

```{r}
ggplot(data = flights, aes(y = ARR_DELAY, x = DEST)) +
  geom_boxplot() +
  labs(x = "Destination",
       title = "Arrival Delay vs Destination")
```

## ARR_DELAY and DAY_OF_WEEK

```{r}
p8 <- ggplot(data = flights, aes(y = ARR_DELAY, x = DAY_OF_WEEK)) +
  geom_point() +
  labs(title = "Arrival Delay vs Day of Week")

p9 <- ggplot(data = flights, aes(y = ARR_DELAY, group = DAY_OF_WEEK)) +
  geom_boxplot() +
  labs(title = "Arrival Delay vs Day of Week")

grid.arrange(p8,p9, nrow = 2)
```

## ARR_DELAY and DAY_OF_MONTH

```{r}
p10 <- ggplot(data = flights, aes(y = ARR_DELAY, x = DAY_OF_MONTH)) +
  geom_point() +
  labs(title = "Arrival Delay vs Day of Month")

p11 <- ggplot(data = flights, aes(y = ARR_DELAY, group = DAY_OF_MONTH)) +
  geom_boxplot() +
  labs(title = "Arrival Delay vs Day of Month")

grid.arrange(p10, p11, nrow = 2)
```


## Further Data Cleaning

```{r destination-change}
# take only SFO/LAX since all 4 carriers fly there
flights <- flights %>% 
  filter(DEST == "SFO" | DEST == "LAX") %>% 
  mutate(TYPE_DELAY = case_when(NAS_DELAY == 1 ~ "NAS",
                                CARRIER_DELAY == 1 ~ "CARRIER",
                                LATE_AIRCRAFT_DELAY == 1 ~ "LATE_AIRCRAFT",
                                TRUE ~ "No Delay"))

ggplot(data = flights, aes(x = TYPE_DELAY)) +
  geom_bar()

unique(flights$TYPE_DELAY)
```

# SPLITTING DATA

```{r}
set.seed(1234)
flights <- flights %>%
  mutate(id = row_number())
train <- flights %>% 
  sample_frac(0.8)
test <- anti_join(flights, train, by = "id")
```


# LINEAR MODELS

Variables that I think we could explore: department delay time, days of month, days of week, taxi-in, taxi-out, destination, Carrier Delay, NAS Delay, and Late Aircraft Delay.

### Full Log-Transformed Model 

```{r new-attempt-lm}
lm.01 <- lm(ARR_DELAY ~ DEP_DELAY + DAY_OF_WEEK + OP_CARRIER + DEST + CRS_DEP_TIME + CRS_ARR_TIME + log_TAXI_OUT + log_TAXI_IN + TYPE_DELAY, train)

#plot(lm.01)
#summary(lm.01)

library(MASS)
step_model <- stepAIC(lm.01, direction = "backward", trace = FALSE)
#summary(step_model)

lm.02 <- lm(ARR_DELAY ~ DEP_DELAY + OP_CARRIER + DEST + CRS_DEP_TIME  + log_TAXI_OUT + log_TAXI_IN + TYPE_DELAY + OP_CARRIER:DEST, train)
#summary(lm.02)
#anova(step_model, lm.02)

lm.03 <- lm(ARR_DELAY ~ DEP_DELAY + OP_CARRIER + DEST + CRS_DEP_TIME  + log_TAXI_OUT + log_TAXI_IN + TYPE_DELAY + OP_CARRIER:DEST + DEST:log_TAXI_IN, train)

#anova(lm.02, lm.03)


log_linear_model <- lm(ARR_DELAY ~ DEP_DELAY + OP_CARRIER + DEST + CRS_DEP_TIME  + log_TAXI_OUT + log_TAXI_IN + TYPE_DELAY + OP_CARRIER:DEST + DEST:log_TAXI_IN+log_TAXI_OUT:DEP_DELAY, train)


anova(lm.03, log_linear_model)

summary(log_linear_model)
plot(log_linear_model)

## SIGNIFICANT INTERACTIONS
#OP_CARRIER:DEST
#DEST:log_TAXI_IN
#CRS_DEP_TIME:DEST (***** makes zero intuitive sense - might not wanna do this)
#CRS_ARR_TIME:log_TAXI_IN
#log_TAXI_OUT:DEP_DELAY

#log_TAXI_OUT:CRS_DEP_TIME (verrrrrry close to 0.05)
# library(broom)
# log_linear_preds <- predict(log_linear_model, test)
# log_linear_MSE <- sum((log_linear_preds-test$ARR_DELAY)^2, na.rm=T)/328
# log_linear_MSE
```

### Plain Linear Model 

```{r take-2}
full_model <- lm(ARR_DELAY ~ 
                    DEP_DELAY + 
                    DAY_OF_WEEK + 
                    OP_CARRIER + 
                    DEST + 
                    CRS_DEP_TIME + 
                    CRS_ARR_TIME + 
                    TAXI_OUT + 
                    TAXI_IN + 
                    TYPE_DELAY, train)

# summary(full_model)
# full_model_preds <- predict(full_model, test)
# linear_MSE <- sum((full_model_preds-test$ARR_DELAY)^2, na.rm=T)/328
# linear_MSE
```

```{r, step-model, message=FALSE}
library(MASS)
step_model <- stepAIC(full_model, trace = FALSE)
#summary(step_model)
plain_linear_model <- step_model
```

 
```{r}
# interaction1 <- lm(ARR_DELAY ~ 
#                     DEP_DELAY + 
#                      OP_CARRIER + 
#                      DEST + 
#                      CRS_DEP_TIME + 
#                      CRS_ARR_TIME + 
#                      TAXI_OUT + 
#                      TAXI_IN + 
#                      TYPE_DELAY,
#                    data = train)

## op_carrier and crs_dep_time almost significant

#anova(step_model, interaction1)

```

```{r}
plain_linear_model

par(mfrow = c(2,2))
plot(plain_linear_model)

```

## Adjusted Model No Log Transforms

```{r}
train$adj_ARR_DELAY = train$ARR_DELAY + 75
adj_linear_model <- lm(adj_ARR_DELAY ~ 
                    DEP_DELAY + 
                     OP_CARRIER + 
                     DEST + 
                     CRS_DEP_TIME + 
                     CRS_ARR_TIME + 
                     TAXI_OUT + 
                     TAXI_IN + 
                     TYPE_DELAY,
                   data = train)

## op_carrier and crs_dep_time almost significant interaction

```

### Box-Cox

```{r box-cox-notranslm}
library(EnvStats)
bc_model <- boxcox(adj_linear_model, optimize = TRUE)
bc_lambda <- bc_model$lambda
bc_lambda
#plot(bc_model)

```

```{r}
library(dplyr)
train <- train %>%
  mutate(bc_adj_ARR_DELAY = ((adj_ARR_DELAY^bc_lambda) - 1)/bc_lambda)

hist(train$adj_ARR_DELAY)
hist(train$bc_adj_ARR_DELAY)
```
## Box-Cox Transformed Linear Model (No Transformed Predictors)

```{r}
bc_adj_linear_model <- lm(bc_adj_ARR_DELAY ~ 
                    DEP_DELAY + 
                     OP_CARRIER + 
                     DEST + 
                     CRS_DEP_TIME + 
                     CRS_ARR_TIME + 
                     TAXI_OUT + 
                     TAXI_IN + 
                     TYPE_DELAY,
                   data = train)
par(mfrow = c(2,2))
plot(bc_adj_linear_model)
```

```{r}
par(mfrow = c(2,2))
plot(adj_linear_model)
```

### Test Error

LOOKING AT:
- log transformed predictors (taxi_in and taxi_out), interactions, no boxcox transformed response
- model without any interactions or transformations: ENDED UP PERFORMING THE BEST!!!
- box-cox transformed response, no interactions or predicted transformations

```{r}
#min(test$ARR_DELAY)
test$log_linear_preds <- predict(log_linear_model, test)

hist(test$log_linear_preds)
hist(test$ARR_DELAY)

log_linear_MSE <- sum((test$log_linear_preds-test$ARR_DELAY)^2, na.rm=T)/328
log_linear_MSE

```

```{r plain-model-test-error}
#min(test$ARR_DELAY)
test$plain_mlr_pred <- predict(plain_linear_model, test)

hist(test$plain_mlr_pred)
hist(test$ARR_DELAY)

plain_linear_model_MSE <- sum((test$ARR_DELAY - test$plain_mlr_pred)^2, na.rm=T)/328
plain_linear_model_MSE
```


```{r bc-model-test-error}
#min(test$ARR_DELAY)
test$adj_ARR_DELAY = test$ARR_DELAY + 77
test$bc_adj_linear_preds <- predict(bc_adj_linear_model, test)
#hist(test$bc_adj_linear_preds)


test <- test %>%
 mutate(adj_linear_preds = ((bc_adj_linear_preds*(bc_lambda) + 1)^(1/bc_lambda)))

test$bc_mlr_pred = test$adj_linear_preds - 77
hist(test$bc_mlr_pred)
hist(test$ARR_DELAY)

bc_adj_linear_model_MSE <- sum((test$ARR_DELAY - test$bc_mlr_pred)^2, na.rm=T)/328
bc_adj_linear_model_MSE
```

# GAM MODEL

## Initial Model

fit a gam model with numerical variables on a smoothing spline

```{r}
gam00 <- gam(ARR_DELAY ~ DAY_OF_WEEK +
                   OP_CARRIER +
                   s(TAXI_IN) +
                   s(TAXI_OUT) +
                   DEST +
                   s(DEP_DELAY) +
                   s(CRS_DEP_TIME) + 
                   s(CRS_ARR_TIME) + 
                   TYPE_DELAY, data = train)

summary(gam00)
```

```{r}
par(mfrow = c(2,3))
plot.gam(gam00, se=TRUE)
```

## Checking Lineartiy

TAXI_IN may be linear

```{r}
gam01 <- gam(ARR_DELAY ~ DAY_OF_WEEK +
                   OP_CARRIER +
                   TAXI_IN +
                   s(TAXI_OUT) +
                   DEST +
                   s(DEP_DELAY) +
                   s(CRS_DEP_TIME) + 
                   s(CRS_ARR_TIME) + 
                   TYPE_DELAY, data = train)

anova(gam00, gam01, test = "F")
```

based on anova test, the model with a smoothing spline on TAXI_IN is a better fit

## More Anova

DAY_OF_WEEK, DEST, and CRS_ARR_TIME have very high p-values, so let's try an anova test without including them

```{r}
gam02 <- gam(ARR_DELAY ~ OP_CARRIER +
                   s(TAXI_IN) +
                   s(TAXI_OUT) +
                   s(DEP_DELAY) +
                   s(CRS_DEP_TIME) + 
                   TYPE_DELAY, data = train)

anova(gam00, gam02, test = "F")
```

based on the anova test, the model excluding these variables is a better fit

## Model Diagnostics

```{r}
summary(gam02)
```

```{r}
par(mfrow = c(2,2))
gam.check(gam02)
```
```{r}
par(mfrow = c(2,2))
plot(gam02)
```


## Test Error

```{r}
gam_preds <- predict.gam(gam02, newdata = test)

hist(gam_preds)
hist(test$ARR_DELAY)

gam_MSE <- sum((test$ARR_DELAY - gam_preds)^2, na.rm=T)/328
gam_MSE
```

## Boxcox Transformed GAM

```{r}
gambc <- gam(bc_adj_ARR_DELAY ~ OP_CARRIER +
                   s(TAXI_IN) +
                   s(TAXI_OUT) +
                   s(DEP_DELAY) +
                   s(CRS_DEP_TIME) + 
                   TYPE_DELAY, data = train)
 
summary(gambc)
```



### BC Model Diagnostics

```{r}
par(mfrow = c(2,2))
gam.check(gambc)
```
```{r}
par(mfrow = c(2,2))
plot(gambc)
```


### BC Test Error

```{r}
gambc_preds <- predict.gam(gambc, newdata = test)
adjgam_preds <- ((gambc_preds*(bc_lambda) + 1)^(1/bc_lambda))
bc_gam_pred = adjgam_preds - 77

hist(bc_gam_pred)
hist(test$ARR_DELAY)

gambc_MSE <- sum((test$ARR_DELAY - bc_gam_pred)^2, na.rm=T)/328
gambc_MSE
```

# TREES

## Random Forests

```{r, message=FALSE}
library(tree)
library(randomForest)
```

By default, ``randomForest()`` uses $p/3$ variables when building a random forest of regression trees.

```{r}
set.seed(1)

# optimal number of predictors (param = mtry) used = 2 based on CV
rf.delay <- randomForest(ARR_DELAY ~ DAY_OF_MONTH +
                   TAXI_IN +
                   TAXI_OUT +
                   DEST +
                   DEP_DELAY +
                   CARRIER_DELAY +
                   NAS_DELAY,
                   data = train, na.action = na.omit, importance = TRUE,
                   ntree=10000, mtry=2)

# test error
yhat.rf <- predict(rf.delay, newdata = test)
rf.MSE <- sum((test$ARR_DELAY - yhat.rf)^2, na.rm=T)/328
rf.MSE
```

```{r}
hist(yhat.rf)
```


Using the ``importance()`` function, we can view the importance of each variable.

```{r}
importance(rf.delay)
```

Two measures of variable importance are reported.  The former is based on the mean decrease in accuracy in predictions on the out of bag samples when a given variable is excluded from the model.  The latter is a measure of the total decrease in node impurity that results from splits over that variable, averaged over all trees (this was plotted in Figure 8.9 in the text).  In the case of regression trees, the node impurity is measured by the training RSS and for classification trees by the deviance.  Plots of these importance measures can be produced using the ``varImpPlot()`` function.

```{r}
varImpPlot(rf.delay)
```

## 4. Boosting 

Here we use the ``gbm()`` package, and within it the ``gbm()`` function, to fit boosted regression trees to the ``train`` data set. We run ``gbm()`` with the option ``distribution = "gaussian"`` since this is a regression problem. The argument ``n.trees = 150`` indicates that we want 150 trees, and the option ``interaction.depth = 3`` limits the depth of each tree.

```{r message = FALSE}
library(gbm)
library(bst)
library(plyr)
library(caret)
set.seed(1)

# find ideal hyper-parameters through CV
gbmFit <- train(ARR_DELAY ~ DAY_OF_MONTH +
                 TAXI_IN +
                 TAXI_OUT +
                 DEP_DELAY +
                 CARRIER_DELAY +
                 NAS_DELAY +
                 LATE_AIRCRAFT_DELAY, data = train, 
                 method = "gbm")

gbmFit

# boosted model wiht cross-validated hyper-parameters
boost.delay <- gbm(ARR_DELAY ~ DAY_OF_MONTH +
                 TAXI_IN +
                 TAXI_OUT +
                 DEP_DELAY +
                 CARRIER_DELAY +
                 NAS_DELAY +
                 LATE_AIRCRAFT_DELAY,
                 data = train, distribution = "gaussian",
                 n.trees=150, interaction.depth=3, shrinkage=0.1, cv.folds=10)
```

The ``summary()`` function also provides a relative influence plot and also outputs the relative influence statistics.

```{r}
summary(boost.delay)
```

We see that ``DEP_DELAY`` and ``DAY_OF_MONTH`` are by far the most important variables. We can also produce *partial dependence plots* for these two variables.  These plots illustrate the marginal effect of the selected variables on the response after ``integrating`` out the other variables.

```{r}
par(mfrow = c(1,2))
plot(boost.delay, i = "DEP_DELAY")
plot(boost.delay, i = "DAY_OF_MONTH")
```

We now use the boosted model to predict ``ARR_DELAY`` on the test set:

```{r}
yhat.boost <- predict(boost.delay, newdata =test,
                      n.trees = 150)
boost_MSE <- sum((test$ARR_DELAY-yhat.boost)^2, na.rm = T)/328
boost_MSE
```

```{r}
hist(yhat.boost)
```

## Test Errors



```{r}
options(scipen = 5, digits = 4)
model.names <- c("Baseline Linear", "Selected Linear w/ Log-Transformed Predictors", "Selected Linear w/ Box-Cox", "GAM", "GAM w/ Box-Cox", "Random Forest", "Boosting")
model.types <- c("Multiple Linear Regression", "Multiple Linear Regression", "Multiple Linear Regression", "Generalized Additive Model", "Generalized Additive Model", "Random Forest", "Boosting")

#model4.ints <- c("FALSE", "FALSE", "FALSE", "FALSE")

model.mse <- c(plain_linear_model_MSE, log_linear_MSE,
                    bc_adj_linear_model_MSE, gam_MSE,
                    gambc_MSE, rf.MSE, boost_MSE)
model.mse.char <- c("322.46", "333.90", "334.92", "312.30", "317.45", "155.01", "129.80")

#model4.cvmse_var <- c(mlr4_1_cv, mlr4_4_bc_cv, ridge.mom4.cvmse, gam4_bc_gcv)
#model4.cvmse <- c(2.284e+20, "25.66", 25.62, 25.79)


#pctchange4_3 <- round(-((ridge.mom4.cvmse - mlr4_4_bc_cv)/mlr4_4_bc_cv)*100, digits = 4)
#pctchange4_4 <- round(-((gam4_bc_gcv - mlr4_4_bc_cv)/mlr4_4_bc_cv)*100, digits = 4)

#model4.pctchange <- c("---", "---", pctchange4_3, pctchange4_4)

errors.df <- data.frame(model.names, 
                         model.types, 
                         model.mse.char
                         )

 #model4.ints, 
#model4.cvmse, 
                         #model4.pctchange


#colnames(errors.df4) <- c("Model Name", "Model Type", "Interactions?", "Model MSE", "Model CV MSE", "Model Percent Improvement")
errors.df
```

```{r}
library(formattable)
formattable(errors.df,
            col.names = c("Model Name", "Model Type", "Model MSE"),
            list(
  model.names = formatter("span", style = x ~ ifelse(x == "Boosting", 
    style(color = "purple", font.weight = "bold"), NA)),
  model.mse.char = formatter("span", style = x ~ ifelse(x == "129.80", 
    style(color = "purple", font.weight = "bold"), NA)),
  model.types = formatter("span", style = x ~ ifelse(x == "Boosting", 
    style(color = "purple", font.weight = "bold"), NA))
))
```



